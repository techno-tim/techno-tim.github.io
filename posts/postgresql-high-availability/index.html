<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="PostgresSQL Clustering the hard wayâ€¦" /><meta property="og:locale" content="en" /><meta name="description" content="Today is the day that you start running PostgresSQL in a cluster! In this tutorial weâ€™ll be setting up a production ready Postgres cluster thatâ€™s highly available and fault tolerant using PostgreSQL, etcd, Patroni, HA Proxy, and keepalived. This resilient combination will ensure that you can always reach your database even when a node in the cluster goes down!" /><meta property="og:description" content="Today is the day that you start running PostgresSQL in a cluster! In this tutorial weâ€™ll be setting up a production ready Postgres cluster thatâ€™s highly available and fault tolerant using PostgreSQL, etcd, Patroni, HA Proxy, and keepalived. This resilient combination will ensure that you can always reach your database even when a node in the cluster goes down!" /><link rel="canonical" href="https://technotim.live/posts/postgresql-high-availability/" /><meta property="og:url" content="https://technotim.live/posts/postgresql-high-availability/" /><meta property="og:site_name" content="Techno Tim" /><meta property="og:image" content="https://technotim.live/assets/img/headers/postgres-high-availability-hero.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-12-07T07:00:00-06:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://technotim.live/assets/img/headers/postgres-high-availability-hero.webp" /><meta property="twitter:title" content="PostgresSQL Clustering the hard wayâ€¦" /><meta name="twitter:site" content="@technotimlive" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-02-19T09:39:18-06:00","datePublished":"2024-12-07T07:00:00-06:00","description":"Today is the day that you start running PostgresSQL in a cluster! In this tutorial weâ€™ll be setting up a production ready Postgres cluster thatâ€™s highly available and fault tolerant using PostgreSQL, etcd, Patroni, HA Proxy, and keepalived. This resilient combination will ensure that you can always reach your database even when a node in the cluster goes down!","headline":"PostgresSQL Clustering the hard wayâ€¦","image":{"lqip":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAf/AABEIAAUACgMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APwX+G3x7+GekfCm8064/ZK+BesT/YLITXeo618cGF80Nu9ldXF4kXxbS5hubyQ2d8w0a+0eygvLaRorHybp4Y/7HybJMXiOHKOKhxBmmHpewqRlhaWFyFwvFOouStVyepWUdJxkqk6s5Rl/ETV5fy5mOa4WjnE6U8ky+vUVaP7+pic4TkruDcqVPM4Uue7jNOEYRUov3LNcv5++KPEfh7WvEviLWdK8A6B4U0zVtd1bU9N8LaNqfiu60fw1YX9/cXVnoGlXOu69q+uXGm6Nbyx6dYz6zqup6rNa20Umo6he3bTXMv4/KnOEpRdaU3GTi5yhSUptOznJQhCCcmrtQhGKbtGMVZL9FjOEkpKjGCkk1CMqjjBNXUYuc5TajsnKUpNL3pN3Z//Z","url":"https://technotim.live/assets/img/headers/postgres-high-availability-hero.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://technotim.live/posts/postgresql-high-availability/"},"url":"https://technotim.live/posts/postgresql-high-availability/"}</script><title>PostgresSQL Clustering the hard way... | Techno Tim</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Techno Tim"><meta name="application-name" content="Techno Tim"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://avatars.githubusercontent.com/u/1322205?s=400&u=5b4f2219006577dc0426007fe5a02391c4899677&v=4" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">Techno Tim</a></h1><p class="site-subtitle fst-italic mb-0">Engineer. Builder. Creator. | From Code to Cloud</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/shop/" class="nav-link"> <i class="fa-fw fas fa-bag-shopping"></i> <span>MERCH</span> </a><li class="nav-item"> <a href="/sponsor/" class="nav-link"> <i class="fa-fw fas fa-handshake"></i> <span>SPONSOR</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://l.technotim.live/links" aria-label="links" target="_blank" rel="noopener noreferrer" > <i class="fa-solid fa-link"></i> </a> <a href="https://twitter.com/technotimlive" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="https://l.technotim.live/github" aria-label="github-custom" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>PostgresSQL Clustering the hard way...</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>PostgresSQL Clustering the hard way...</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1733576400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 7, 2024 </time> </span> <span> Updated <time data-ts="1739979558" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 19, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/img/headers/postgres-high-availability-hero.webp" class="popup img-link preview-img blur"><img data-src="/assets/img/headers/postgres-high-availability-hero.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAf/AABEIAAUACgMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APwX+G3x7+GekfCm8064/ZK+BesT/YLITXeo618cGF80Nu9ldXF4kXxbS5hubyQ2d8w0a+0eygvLaRorHybp4Y/7HybJMXiOHKOKhxBmmHpewqRlhaWFyFwvFOouStVyepWUdJxkqk6s5Rl/ETV5fy5mOa4WjnE6U8ky+vUVaP7+pic4TkruDcqVPM4Uue7jNOEYRUov3LNcv5++KPEfh7WvEviLWdK8A6B4U0zVtd1bU9N8LaNqfiu60fw1YX9/cXVnoGlXOu69q+uXGm6Nbyx6dYz6zqup6rNa20Umo6he3bTXMv4/KnOEpRdaU3GTi5yhSUptOznJQhCCcmrtQhGKbtGMVZL9FjOEkpKjGCkk1CMqjjBNXUYuc5TajsnKUpNL3pN3Z//Z"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://l.technotim.live/twitter">Techno Tim</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4216 words" > <em>23 min</em> read</span></div></div></header><div class="content"><p>Today is the day that you start running PostgresSQL in a cluster! In this tutorial weâ€™ll be setting up a production ready Postgres cluster thatâ€™s highly available and fault tolerant using PostgreSQL, etcd, Patroni, HA Proxy, and keepalived. This resilient combination will ensure that you can always reach your database even when a node in the cluster goes down!</p><iframe class="embed-video youtube" loading="lazy" src="https://www.youtube.com/embed/RHwglGf_z40" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><p>ðŸ“º <a href="https://www.youtube.com/watch?v=RHwglGf_z40">Watch Video</a></p><h2 id="nodes"><span class="me-2">Nodes</span><a href="#nodes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c"># ha proxy</span>
192.168.60.100 <span class="c"># haproxy-01</span>
192.168.60.101 <span class="c"># haproxy-02</span>
192.168.60.102 <span class="c"># haproxy-03</span>

<span class="c"># postgres</span>
192.168.60.103 <span class="c"># postgres-01</span>
192.168.60.104 <span class="c"># postgres-02</span>
192.168.60.105 <span class="c"># postgres-03</span>
</pre></table></code></div></div><h2 id="postgresql"><span class="me-2">PostgreSQL</span><a href="#postgresql" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>On postgres nodes install latest postgres.</p><p>Install updated postgres repositories.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> postgresql-common
<span class="nb">sudo</span> /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh
</pre></table></code></div></div><p>Install postgres and additional modules.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> postgresql postgresql-contrib
</pre></table></code></div></div><p>Weâ€™ll configure postgres later.</p><p>Stop and disable the service because Patroni will handle the lifecycle of postgres</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl stop postgresql
<span class="nb">sudo </span>systemctl disable postgresql
</pre></table></code></div></div><h2 id="etcd"><span class="me-2">etcd</span><a href="#etcd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="install"><span class="me-2">Install</span><a href="#install" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This should be installed on the postgres servers.</p><p>Make sure you have <code class="language-plaintext highlighter-rouge">wget</code> and <code class="language-plaintext highlighter-rouge">curl</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> wget curl
</pre></table></code></div></div><p>Find latest release.</p><p><a href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>wget https://github.com/etcd-io/etcd/releases/download/v3.5.17/etcd-v3.5.17-linux-amd64.tar.gz
</pre></table></code></div></div><p>Uncompress and rename.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">tar </span>xvf etcd-v3.5.17-linux-amd64.tar.gz
<span class="nb">mv </span>etcd-v3.5.17-linux-amd64 etcd
</pre></table></code></div></div><p>Move all binaries into <code class="language-plaintext highlighter-rouge">/usr/local/bin/</code> for later use.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo mv </span>etcd/etcd<span class="k">*</span> /usr/local/bin/
</pre></table></code></div></div><p>Check <code class="language-plaintext highlighter-rouge">etcd</code> version</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>etcd <span class="nt">--version</span>
</pre></table></code></div></div><p>Should see something like:</p><pre><code class="language-log">etcd Version: 3.5.17
Git SHA: 507c0deÃŸ
Go Version: go1.22.9obs
Go OS/Arch: linux/amd64
</code></pre><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>etcdctl version
</pre></table></code></div></div><p>Should see something like:</p><pre><code class="language-log">etcdctl version: 3.5.17
API version: 3.5
</code></pre><p>Letâ€™s create a user for <code class="language-plaintext highlighter-rouge">etcd</code> service.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>useradd <span class="nt">--system</span> <span class="nt">--home</span> /var/lib/etcd <span class="nt">--shell</span> /bin/false etcd
</pre></table></code></div></div><p>Before configuring <code class="language-plaintext highlighter-rouge">etcd</code>, we need to repeat all of these steps for the other 2 nodes.</p><p>Letâ€™s configure <code class="language-plaintext highlighter-rouge">etcd</code>.</p><p>Make dir and edit file.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/etcd
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/etcd/ssl
</pre></table></code></div></div><h3 id="certificates"><span class="me-2">Certificates</span><a href="#certificates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Weâ€™ll be securing the communication between <code class="language-plaintext highlighter-rouge">etcd</code> nodes and postgres.</p><p>On our own machine (not servers!)</p><p>Make sure <code class="language-plaintext highlighter-rouge">openssl</code> is installed</p><p>Windows</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">winget</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nt">-e</span><span class="w"> </span><span class="nt">--id</span><span class="w"> </span><span class="nx">FireDaemon.OpenSSL</span><span class="w">
</span></pre></table></code></div></div><p>macOS</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>openssl
</pre></table></code></div></div><p>Linux</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>openssl
</pre></table></code></div></div><p>Verify itâ€™s installed and working</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>openssl version
</pre></table></code></div></div><p>Should see something like:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>OpenSSL 3.4.0 22 Oct 2024 <span class="o">(</span>Library: OpenSSL 3.4.0 22 Oct 2024<span class="o">)</span>
</pre></table></code></div></div><p>Now letâ€™s generate and configure certs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">mkdir </span>certs
<span class="nb">cd </span>certs
</pre></table></code></div></div><p>Generate cert authority</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>openssl genrsa <span class="nt">-out</span> ca.key 2048
openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-key</span> ca.key <span class="nt">-subj</span> <span class="s2">"/CN=etcd-ca"</span> <span class="nt">-days</span> 7300 <span class="nt">-out</span> ca.crt
</pre></table></code></div></div><p>Generate certificate each node. Note, pay attention to SANS, I am using IP, update with your IP and oh DNS/hostname.</p><p>node1</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c"># Generate a private key</span>
openssl genrsa <span class="nt">-out</span> etcd-node1.key 2048

<span class="c"># Create temp file for config</span>
<span class="nb">cat</span> <span class="o">&gt;</span> temp.cnf <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
[ req ]
distinguished_name = req_distinguished_name
req_extensions = v3_req
[ req_distinguished_name ]
[ v3_req ]
subjectAltName = @alt_names
[ alt_names ]
IP.1 = 192.168.60.103
IP.2 = 127.0.0.1
</span><span class="no">EOF

</span><span class="c"># Create a csr</span>
openssl req <span class="nt">-new</span> <span class="nt">-key</span> etcd-node1.key <span class="nt">-out</span> etcd-node1.csr <span class="se">\</span>
  <span class="nt">-subj</span> <span class="s2">"/C=US/ST=YourState/L=YourCity/O=YourOrganization/OU=YourUnit/CN=etcd-node1"</span> <span class="se">\</span>
  <span class="nt">-config</span> temp.cnf

<span class="c"># Sign the cert</span>
openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> etcd-node1.csr <span class="nt">-CA</span> ca.crt <span class="nt">-CAkey</span> ca.key <span class="nt">-CAcreateserial</span> <span class="se">\</span>
  <span class="nt">-out</span> etcd-node1.crt <span class="nt">-days</span> 7300 <span class="nt">-sha256</span> <span class="nt">-extensions</span> v3_req <span class="nt">-extfile</span> temp.cnf

<span class="c"># Verify the cert and be sure you see Subject Name Alternative</span>

openssl x509 <span class="nt">-in</span> etcd-node1.crt <span class="nt">-text</span> <span class="nt">-noout</span> | <span class="nb">grep</span> <span class="nt">-A1</span> <span class="s2">"Subject Alternative Name"</span>

<span class="c"># Remove temp file</span>

<span class="nb">rm </span>temp.cnf
</pre></table></code></div></div><p>node 2</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c"># Generate a private key</span>
openssl genrsa <span class="nt">-out</span> etcd-node2.key 2048

<span class="c"># Create temp file for config</span>
<span class="nb">cat</span> <span class="o">&gt;</span> temp.cnf <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
[ req ]
distinguished_name = req_distinguished_name
req_extensions = v3_req
[ req_distinguished_name ]
[ v3_req ]
subjectAltName = @alt_names
[ alt_names ]
IP.1 = 192.168.60.104
IP.2 = 127.0.0.1
</span><span class="no">EOF

</span><span class="c"># Create a csr</span>
openssl req <span class="nt">-new</span> <span class="nt">-key</span> etcd-node2.key <span class="nt">-out</span> etcd-node2.csr <span class="se">\</span>
  <span class="nt">-subj</span> <span class="s2">"/C=US/ST=YourState/L=YourCity/O=YourOrganization/OU=YourUnit/CN=etcd-node2"</span> <span class="se">\</span>
  <span class="nt">-config</span> temp.cnf

<span class="c"># Sign the cert</span>
openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> etcd-node2.csr <span class="nt">-CA</span> ca.crt <span class="nt">-CAkey</span> ca.key <span class="nt">-CAcreateserial</span> <span class="se">\</span>
  <span class="nt">-out</span> etcd-node2.crt <span class="nt">-days</span> 7300 <span class="nt">-sha256</span> <span class="nt">-extensions</span> v3_req <span class="nt">-extfile</span> temp.cnf

<span class="c"># Verify the cert and be sure you see Subject Name Alternative</span>
openssl x509 <span class="nt">-in</span> etcd-node2.crt <span class="nt">-text</span> <span class="nt">-noout</span> | <span class="nb">grep</span> <span class="nt">-A1</span> <span class="s2">"Subject Alternative Name"</span>

<span class="c"># Remove temp file</span>
<span class="nb">rm </span>temp.cnf
</pre></table></code></div></div><p>node3</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c"># Generate a private key</span>
openssl genrsa <span class="nt">-out</span> etcd-node3.key 2048

<span class="c"># Create temp file for config</span>
<span class="nb">cat</span> <span class="o">&gt;</span> temp.cnf <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
[ req ]
distinguished_name = req_distinguished_name
req_extensions = v3_req
[ req_distinguished_name ]
[ v3_req ]
subjectAltName = @alt_names
[ alt_names ]
IP.1 = 192.168.60.105
IP.2 = 127.0.0.1
</span><span class="no">EOF

</span><span class="c"># Create a csr</span>
openssl req <span class="nt">-new</span> <span class="nt">-key</span> etcd-node3.key <span class="nt">-out</span> etcd-node3.csr <span class="se">\</span>
  <span class="nt">-subj</span> <span class="s2">"/C=US/ST=YourState/L=YourCity/O=YourOrganization/OU=YourUnit/CN=etcd-node3"</span> <span class="se">\</span>
  <span class="nt">-config</span> temp.cnf

<span class="c">#Sign the cert</span>
openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> etcd-node3.csr <span class="nt">-CA</span> ca.crt <span class="nt">-CAkey</span> ca.key <span class="nt">-CAcreateserial</span> <span class="se">\</span>
  <span class="nt">-out</span> etcd-node3.crt <span class="nt">-days</span> 7300 <span class="nt">-sha256</span> <span class="nt">-extensions</span> v3_req <span class="nt">-extfile</span> temp.cnf

<span class="c"># Verify the cert and be sure you see Subject Name Alternative</span>
openssl x509 <span class="nt">-in</span> etcd-node3.crt <span class="nt">-text</span> <span class="nt">-noout</span> | <span class="nb">grep</span> <span class="nt">-A1</span> <span class="s2">"Subject Alternative Name"</span>

<span class="c"># Remove temp file</span>
<span class="nb">rm </span>temp.cnf
</pre></table></code></div></div><p>List all files</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">ls</span>
</pre></table></code></div></div><p>Should see:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>ca.crt
ca.key
ca.srl
etcd-node1.crt
etcd-node1.csr
etcd-node2.crt
etcd-node2.csr
etcd-node2.key
etcd-node3.crt
etcd-node3.csr
etcd-node3.key
</pre></table></code></div></div><p>Secure copy (<code class="language-plaintext highlighter-rouge">scp</code>) the certs to each node:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>scp ca.crt etcd-node1.crt etcd-node1.key serveradmin@192.168.60.103:/tmp/
scp ca.crt etcd-node2.crt etcd-node2.key serveradmin@192.168.60.104:/tmp/
scp ca.crt etcd-node3.crt etcd-node3.key serveradmin@192.168.60.105:/tmp/
</pre></table></code></div></div><p>Should see:</p><p><code class="language-plaintext highlighter-rouge">ssh</code> into each node</p><p>We need to move certs from <code class="language-plaintext highlighter-rouge">/tmp</code> to ssl location (<code class="language-plaintext highlighter-rouge">/etc/etcd/ssl</code>)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/etcd/ssl
<span class="nb">sudo mv</span> /tmp/etcd-node<span class="k">*</span>.crt /etc/etcd/ssl/
<span class="nb">sudo mv</span> /tmp/etcd-node<span class="k">*</span>.key /etc/etcd/ssl/
<span class="nb">sudo mv</span> /tmp/ca.crt /etc/etcd/ssl/
<span class="nb">sudo chown</span> <span class="nt">-R</span> etcd:etcd /etc/etcd/
<span class="nb">sudo chmod </span>600 /etc/etcd/ssl/etcd-node<span class="k">*</span>.key
<span class="nb">sudo chmod </span>644 /etc/etcd/ssl/etcd-node<span class="k">*</span>.crt /etc/etcd/ssl/ca.crt
</pre></table></code></div></div><h3 id="configure"><span class="me-2">Configure</span><a href="#configure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Create our config</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/etcd/etcd.env
</pre></table></code></div></div><p>node1</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nv">ETCD_NAME</span><span class="o">=</span><span class="s2">"postgresql-01"</span>
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd"</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"postgresql-01=https://192.168.60.103:2380,postgresql-02=https://192.168.60.104:2380,postgresql-03=https://192.168.60.105:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">"etcd-cluster"</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.60.103:2380"</span>
<span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">"https://0.0.0.0:2380"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://0.0.0.0:2379"</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.60.103:2379"</span>
<span class="nv">ETCD_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/ca.crt"</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node1.crt"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node1.key"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/ca.crt"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node1.crt"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node1.key"</span>
</pre></table></code></div></div><p>node2</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nv">ETCD_NAME</span><span class="o">=</span><span class="s2">"postgresql-02"</span>
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd"</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"postgresql-01=https://192.168.60.103:2380,postgresql-02=https://192.168.60.104:2380,postgresql-03=https://192.168.60.105:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">"etcd-cluster"</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.60.104:2380"</span>
<span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">"https://0.0.0.0:2380"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://0.0.0.0:2379"</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.60.104:2379"</span>
<span class="nv">ETCD_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/ca.crt"</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node2.crt"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node2.key"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/ca.crt"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node2.crt"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node2.key"</span>
</pre></table></code></div></div><p>node 3</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nv">ETCD_NAME</span><span class="o">=</span><span class="s2">"postgresql-03"</span>
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd"</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"postgresql-01=https://192.168.60.103:2380,postgresql-02=https://192.168.60.104:2380,postgresql-03=https://192.168.60.105:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">"etcd-cluster"</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.60.105:2380"</span>
<span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">"https://0.0.0.0:2380"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://0.0.0.0:2379"</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.60.105:2379"</span>
<span class="nv">ETCD_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/ca.crt"</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node3.crt"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node3.key"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/ca.crt"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node3.crt"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-node3.key"</span>
</pre></table></code></div></div><p>Now letâ€™s create a service for etcd on all 3 nodes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/systemd/system/etcd.service
</pre></table></code></div></div><p>Contents of service file, same for all 3 nodes</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>etcd key-value store
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/etcd-io/etcd
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/etcd/etcd.env
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/etcd
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>10s
<span class="nv">LimitNOFILE</span><span class="o">=</span>40000
<span class="nv">User</span><span class="o">=</span>etcd
<span class="nv">Group</span><span class="o">=</span>etcd

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</pre></table></code></div></div><p>We need to create a directory for <code class="language-plaintext highlighter-rouge">etcd</code> <code class="language-plaintext highlighter-rouge">ETCD_DATA_DIR</code> defined in service file.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/etcd 
<span class="nb">sudo chown</span> <span class="nt">-R</span> etcd:etcd /var/lib/etcd
</pre></table></code></div></div><h3 id="running-etcd"><span class="me-2">Running etcd</span><a href="#running-etcd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Reload daemon and enable the service</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>etcd
</pre></table></code></div></div><p>Start etcd and check status</p><p>this looks like itâ€™s hanging on the first node but once you add another node it will complete</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl start etcd
<span class="nb">sudo </span>systemctl status etcd
</pre></table></code></div></div><p>Should see something like:</p><pre><code class="language-log">â— etcd.service - etcd key-value store
     Loaded: loaded (/etc/systemd/system/etcd.service; enabled; preset: enabled)
     Active: active (running) since Mon 2024-12-02 14:09:30 CST; 2s ago
       Docs: https://github.com/etcd-io/etcd
   Main PID: 7266 (etcd)
      Tasks: 9 (limit: 4612)
     Memory: 29.3M (peak: 30.0M)
        CPU: 246ms
     CGroup: /system.slice/etcd.service
             â””â”€7266 /usr/local/bin/etcd
</code></pre><p>You can also check the logs for <code class="language-plaintext highlighter-rouge">etcd</code> by running:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>journalctl <span class="nt">-xeu</span> etcd.service
</pre></table></code></div></div><p>Should see something like:</p><pre><code class="language-log">â–‘â–‘ Subject: A start job for unit etcd.service has finished successfully
â–‘â–‘ Defined-By: systemd
â–‘â–‘ Support: http://www.ubuntu.com/support
â–‘â–‘
â–‘â–‘ A start job for unit etcd.service has finished successfully.
â–‘â–‘
â–‘â–‘ The job identifier is 5757.
Dec 02 14:09:30 postgres-01 etcd[7266]: {"level":"info","ts":"2024-12-02T14:09:30.862122-0600","caller":"v3rpc/health.go:61","msg":"grpc service status changed","service":"","status":"SERVING"}
Dec 02 14:09:30 postgres-01 etcd[7266]: {"level":"info","ts":"2024-12-02T14:09:30.862347-0600","caller":"embed/serve.go:187","msg":"serving client traffic insecurely; this is strongly discouraged!","traffic":"grpc+http","address":"[::]:2379"}
</code></pre><h3 id="verification"><span class="me-2">Verification</span><a href="#verification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Once cluster is running, we should verify itâ€™s working on each by running</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>etcdctl endpoint health
etcdctl member list
</pre></table></code></div></div><p>Should see something like on node1:</p><pre><code class="language-log">127.0.0.1:2379 is healthy: successfully committed proposal: took = 1.786976ms
eb8ee14ab5150b4, started, postgresql-01, http://192.168.60.103:2380, http://192.168.60.103:2379, false
34e89b244664f02d, started, postgresql-02, http://192.168.60.104:2380, http://192.168.60.104:2379, false
8ee2a9473a41c400, started, postgresql-03, http://192.168.60.105:2380, http://192.168.60.105:2379, false
</code></pre><p>Do this for all 3 nodes</p><p>Now we should now edit the variables since the cluster is bootstrapped</p><p>Then restart etcd and verify the cluster is still working</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart etcd
</pre></table></code></div></div><p>If you want to run the following commands without sudo, you can run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>usermod <span class="nt">-aG</span> etcd <span class="nv">$USER</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre> <span class="nb">sudo </span>etcdctl <span class="se">\</span>
<span class="nt">--endpoints</span><span class="o">=</span>https://127.0.0.1:2379 <span class="se">\</span>
<span class="nt">--cacert</span><span class="o">=</span>/etc/etcd/ssl/ca.crt <span class="se">\</span>
<span class="nt">--cert</span><span class="o">=</span>/etc/etcd/ssl/etcd-node1.crt <span class="se">\</span>
<span class="nt">--key</span><span class="o">=</span>/etc/etcd/ssl/etcd-node1.key <span class="se">\</span>
endpoint health

<span class="nb">sudo </span>etcdctl <span class="se">\</span>
<span class="nt">--endpoints</span><span class="o">=</span>https://127.0.0.1:2379 <span class="se">\</span>
<span class="nt">--cacert</span><span class="o">=</span>/etc/etcd/ssl/ca.crt <span class="se">\</span>
<span class="nt">--cert</span><span class="o">=</span>/etc/etcd/ssl/etcd-node1.crt <span class="se">\</span>
<span class="nt">--key</span><span class="o">=</span>/etc/etcd/ssl/etcd-node1.key <span class="se">\</span>
member list
</pre></table></code></div></div><p>Should see something like</p><pre><code class="language-log">https://127.0.0.1:2379 is healthy: successfully committed proposal: took = 4.611121ms
59afb19d7cb2565d, started, postgresql-01, https://192.168.60.103:2380, https://192.168.60.103:2379, false
6338565ebcb76aa2, started, postgresql-02, https://192.168.60.104:2380, https://192.168.60.104:2379, false
9d74b3125c745c74, started, postgresql-03, https://192.168.60.105:2380, https://192.168.60.105:2379, false
</code></pre><p>You can check to see who is leader by running</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>etcdctl <span class="se">\</span>
  <span class="nt">--endpoints</span><span class="o">=</span>https://192.168.60.103:2379,https://192.168.60.104:2379,https://192.168.60.105:2379 <span class="se">\</span>
  <span class="nt">--cacert</span><span class="o">=</span>/etc/etcd/ssl/ca.crt <span class="se">\</span>
  <span class="nt">--cert</span><span class="o">=</span>/etc/etcd/ssl/etcd-node1.crt <span class="se">\</span>
  <span class="nt">--key</span><span class="o">=</span>/etc/etcd/ssl/etcd-node1.key <span class="se">\</span>
  endpoint status <span class="nt">--write-out</span><span class="o">=</span>table
</pre></table></code></div></div><p>You should see something like this, specifically one of the nodes <code class="language-plaintext highlighter-rouge">IS LEADER = true</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|          ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| https://192.168.60.103:2379 | 59afb19d7cb2565d |  3.5.17 |   20 kB |      <span class="nb">true</span> |      <span class="nb">false</span> |         2 |         12 |                 12 |        |
| https://192.168.60.104:2379 | 6338565ebcb76aa2 |  3.5.17 |   20 kB |     <span class="nb">false</span> |      <span class="nb">false</span> |         2 |         12 |                 12 |        |
| https://192.168.60.105:2379 | 9d74b3125c745c74 |  3.5.17 |   20 kB |     <span class="nb">false</span> |      <span class="nb">false</span> |         2 |         12 |                 12 |        |
+-----------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</pre></table></code></div></div><h2 id="postgresql-and-patroni"><span class="me-2">PostgreSQL and Patroni</span><a href="#postgresql-and-patroni" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="postgresql-certificates"><span class="me-2">PostgreSQL Certificates</span><a href="#postgresql-certificates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Once this is all set up and working, we can now configure <code class="language-plaintext highlighter-rouge">postgres</code> and <code class="language-plaintext highlighter-rouge">patroni</code>.</p><p>We need to create some dirs for <code class="language-plaintext highlighter-rouge">postgres</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/postgresql/data
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/postgresql/ssl
</pre></table></code></div></div><p>Notice we are using ssl, we need to generate a certificate</p><p>Generate a self-signed certificate</p><p>(this will last 20 years)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>openssl genrsa <span class="nt">-out</span> server.key 2048 <span class="c"># private key</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>openssl req <span class="nt">-new</span> <span class="nt">-key</span> server.key <span class="nt">-out</span> server.req <span class="c"># csr</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>openssl req <span class="nt">-x509</span> <span class="nt">-key</span> server.key <span class="nt">-in</span> server.req <span class="nt">-out</span> server.crt <span class="nt">-days</span> 7300 <span class="c"># generate cert, valid for 20 years</span>
</pre></table></code></div></div><p>Update permissions</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">chmod </span>600 server.key
</pre></table></code></div></div><p>Move files to cert location</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo mv </span>server.crt server.key server.req /var/lib/postgresql/ssl
</pre></table></code></div></div><p>After doing this, we need to copy this to our other servers</p><p>Copy files locally from (your local machine!) to node1, node2, node3 using <code class="language-plaintext highlighter-rouge">scp</code></p><p><code class="language-plaintext highlighter-rouge">scp</code> them to node1, node2, and node3</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>scp server.crt server.key server.req serveradmin@192.168.60.103:/tmp
scp server.crt server.key server.req serveradmin@192.168.60.104:/tmp
scp server.crt server.key server.req serveradmin@192.168.60.105:/tmp
</pre></table></code></div></div><p>On the servers (not your local machine) move files</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /tmp
<span class="nb">sudo mv </span>server.crt server.key server.req /var/lib/postgresql/ssl
</pre></table></code></div></div><p>Update permissions on certificate</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nb">sudo chmod </span>600 /var/lib/postgresql/ssl/server.key
<span class="nb">sudo chmod </span>644 /var/lib/postgresql/ssl/server.crt
<span class="nb">sudo chmod </span>600 /var/lib/postgresql/ssl/server.req
<span class="nb">sudo chown </span>postgres:postgres /var/lib/postgresql/data
<span class="nb">sudo chown </span>postgres:postgres /var/lib/postgresql/ssl/server.<span class="k">*</span>
</pre></table></code></div></div><p>We will need to give the postgres user read access to the etcd certificates using acls</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> acl
</pre></table></code></div></div><p>node1</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/ca.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node1.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node1.key
</pre></table></code></div></div><p>node2</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/ca.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node2.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node2.key
</pre></table></code></div></div><p>node3</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/ca.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node3.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node3.key
</pre></table></code></div></div><p>Now that we have postgres certs configured, itâ€™s now time to configure patroni to operate or drive postgres</p><h2 id="patroni"><span class="me-2">Patroni</span><a href="#patroni" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="installing-patroni"><span class="me-2">Installing Patroni</span><a href="#installing-patroni" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> patroni
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ssh</code> into node1</p><p>Make a dir for <code class="language-plaintext highlighter-rouge">patroni</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/patroni/
</pre></table></code></div></div><h3 id="configuring-patroni"><span class="me-2">Configuring Patroni</span><a href="#configuring-patroni" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Create a config file and edit</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/patroni/config.yml
</pre></table></code></div></div><p>node1</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="na">scope</span><span class="pi">:</span> <span class="s">postgresql-cluster</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">/service/</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">postgresql-01</span>  <span class="c1"># node1</span>

<span class="na">etcd3</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">192.168.60.103:2379,192.168.60.104:2379,192.168.60.105:2379</span>  <span class="c1"># etcd cluster nodes</span>
  <span class="na">protocol</span><span class="pi">:</span> <span class="s">https</span>
  <span class="na">cacert</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/ca.crt</span>
  <span class="na">cert</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/etcd-node1.crt</span>  <span class="c1"># node1's etcd certificate</span>
  <span class="na">key</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/etcd-node1.key</span>  <span class="c1"># node1's etcd key</span>

<span class="na">restapi</span><span class="pi">:</span>
  <span class="na">listen</span><span class="pi">:</span> <span class="s">0.0.0.0:8008</span>
  <span class="na">connect_address</span><span class="pi">:</span> <span class="s">192.168.60.103:8008</span>  <span class="c1"># IP for node1's REST API</span>
  <span class="na">certfile</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.pem</span>

<span class="na">bootstrap</span><span class="pi">:</span>
  <span class="na">dcs</span><span class="pi">:</span>
    <span class="na">ttl</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">loop_wait</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">retry_timeout</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">maximum_lag_on_failover</span><span class="pi">:</span> <span class="m">1048576</span>  <span class="c1"># Failover parameters</span>
    <span class="na">postgresql</span><span class="pi">:</span>
        <span class="na">parameters</span><span class="pi">:</span>
            <span class="na">ssl</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>  <span class="c1"># Enable SSL</span>
            <span class="na">ssl_cert_file</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.crt</span>  <span class="c1"># PostgreSQL server certificate</span>
            <span class="na">ssl_key_file</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.key</span>  <span class="c1"># PostgreSQL server key</span>
        <span class="na">pg_hba</span><span class="pi">:</span>  <span class="c1"># Access rules</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 127.0.0.1/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.103/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.104/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.105/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl all all 127.0.0.1/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl all all 0.0.0.0/0 md5</span>
  <span class="na">initdb</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">encoding</span><span class="pi">:</span> <span class="s">UTF8</span>
    <span class="pi">-</span> <span class="s">data-checksums</span>

<span class="na">postgresql</span><span class="pi">:</span>
  <span class="na">listen</span><span class="pi">:</span> <span class="s">0.0.0.0:5432</span>
  <span class="na">connect_address</span><span class="pi">:</span> <span class="s">192.168.60.103:5432</span>  <span class="c1"># IP for node1's PostgreSQL</span>
  <span class="na">data_dir</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/data</span>
  <span class="na">bin_dir</span><span class="pi">:</span> <span class="s">/usr/lib/postgresql/17/bin</span>  <span class="c1"># Binary directory for PostgreSQL 17</span>
  <span class="na">authentication</span><span class="pi">:</span>
    <span class="na">superuser</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">cnV2abjbDpbh64e12987wR4mj5kQ3456Y0Qf</span>  <span class="c1"># Superuser password - be sure to change</span>
    <span class="na">replication</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">replicator</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">sad9a23jga8jsuedrwtsskj74567suiuwe23</span>  <span class="c1"># Replication password - be sure to change</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">max_connections</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">shared_buffers</span><span class="pi">:</span> <span class="s">256MB</span>

<span class="na">tags</span><span class="pi">:</span>
  <span class="na">nofailover</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">noloadbalance</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">clonefrom</span><span class="pi">:</span> <span class="kc">false</span>
</pre></table></code></div></div><p>node2</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="na">scope</span><span class="pi">:</span> <span class="s">postgresql-cluster</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">/service/</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">postgresql-02</span>  <span class="c1"># Unique name for Node 2</span>

<span class="na">etcd3</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">192.168.60.103:2379,192.168.60.104:2379,192.168.60.105:2379</span>  <span class="c1"># etcd cluster nodes</span>
  <span class="na">protocol</span><span class="pi">:</span> <span class="s">https</span>
  <span class="na">cacert</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/ca.crt</span>
  <span class="na">cert</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/etcd-node2.crt</span>  <span class="c1"># Node 2's etcd certificate</span>
  <span class="na">key</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/etcd-node2.key</span>  <span class="c1"># Node 2's etcd key</span>

<span class="na">restapi</span><span class="pi">:</span>
  <span class="na">listen</span><span class="pi">:</span> <span class="s">0.0.0.0:8008</span>
  <span class="na">connect_address</span><span class="pi">:</span> <span class="s">192.168.60.104:8008</span>  <span class="c1"># IP for Node 2's REST API</span>
  <span class="na">certfile</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.pem</span>

<span class="na">bootstrap</span><span class="pi">:</span>
  <span class="na">dcs</span><span class="pi">:</span>
    <span class="na">ttl</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">loop_wait</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">retry_timeout</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">maximum_lag_on_failover</span><span class="pi">:</span> <span class="m">1048576</span>
    <span class="na">postgresql</span><span class="pi">:</span>
        <span class="na">parameters</span><span class="pi">:</span>
        <span class="na">ssl</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
        <span class="na">ssl_cert_file</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.crt</span>
        <span class="na">ssl_key_file</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.key</span>
        <span class="na">pg_hba</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 127.0.0.1/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.103/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.104/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.105/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl all all 127.0.0.1/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl all all 0.0.0.0/0 md5</span>
  <span class="na">initdb</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">encoding</span><span class="pi">:</span> <span class="s">UTF8</span>
    <span class="pi">-</span> <span class="s">data-checksums</span>

<span class="na">postgresql</span><span class="pi">:</span>
  <span class="na">listen</span><span class="pi">:</span> <span class="s">0.0.0.0:5432</span>
  <span class="na">connect_address</span><span class="pi">:</span> <span class="s">192.168.60.104:5432</span>  <span class="c1"># IP for Node 2's PostgreSQL</span>
  <span class="na">data_dir</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/data</span>
  <span class="na">bin_dir</span><span class="pi">:</span> <span class="s">/usr/lib/postgresql/17/bin</span>
  <span class="na">authentication</span><span class="pi">:</span>
    <span class="na">superuser</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">cnV2abjbDpbh64e12987wR4mj5kQ3456Y0Qf</span>  <span class="c1"># Superuser password (provided)</span>
    <span class="na">replication</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">replicator</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">sad9a23jga8jsuedrwtsskj74567suiuwe23</span>  <span class="c1"># Replication password (provided)</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">max_connections</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">shared_buffers</span><span class="pi">:</span> <span class="s">256MB</span>

<span class="na">tags</span><span class="pi">:</span>
  <span class="na">nofailover</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">noloadbalance</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">clonefrom</span><span class="pi">:</span> <span class="kc">false</span>
</pre></table></code></div></div><p>node3</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="na">scope</span><span class="pi">:</span> <span class="s">postgresql-cluster</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">/service/</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">postgresql-03</span>  <span class="c1"># Unique name for Node 3</span>

<span class="na">etcd3</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">192.168.60.103:2379,192.168.60.104:2379,192.168.60.105:2379</span> <span class="c1">#etcd cluster nodes</span>
  <span class="na">protocol</span><span class="pi">:</span> <span class="s">https</span>
  <span class="na">cacert</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/ca.crt</span>
  <span class="na">cert</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/etcd-node3.crt</span>  <span class="c1"># Node 3's etcd certificate</span>
  <span class="na">key</span><span class="pi">:</span> <span class="s">/etc/etcd/ssl/etcd-node3.key</span>  <span class="c1"># Node 3's etcd key</span>

<span class="na">restapi</span><span class="pi">:</span>
  <span class="na">listen</span><span class="pi">:</span> <span class="s">0.0.0.0:8008</span>
  <span class="na">connect_address</span><span class="pi">:</span> <span class="s">192.168.60.105:8008</span>  <span class="c1"># IP for Node 3's REST API</span>
  <span class="na">certfile</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.pem</span>

<span class="na">bootstrap</span><span class="pi">:</span>
  <span class="na">dcs</span><span class="pi">:</span>
    <span class="na">ttl</span><span class="pi">:</span> <span class="m">30</span>
    <span class="na">loop_wait</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">retry_timeout</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">maximum_lag_on_failover</span><span class="pi">:</span> <span class="m">1048576</span>
    <span class="na">postgresql</span><span class="pi">:</span>
        <span class="na">parameters</span><span class="pi">:</span>
        <span class="na">ssl</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
        <span class="na">ssl_cert_file</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.crt</span>
        <span class="na">ssl_key_file</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/ssl/server.key</span>
        <span class="na">pg_hba</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 127.0.0.1/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.103/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.104/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl replication replicator 192.168.60.105/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl all all 127.0.0.1/32 md5</span>
        <span class="pi">-</span> <span class="s">hostssl all all 0.0.0.0/0 md5</span>
  <span class="na">initdb</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">encoding</span><span class="pi">:</span> <span class="s">UTF8</span>
    <span class="pi">-</span> <span class="s">data-checksums</span>

<span class="na">postgresql</span><span class="pi">:</span>
  <span class="na">listen</span><span class="pi">:</span> <span class="s">0.0.0.0:5432</span>
  <span class="na">connect_address</span><span class="pi">:</span> <span class="s">192.168.60.105:5432</span>  <span class="c1"># IP for Node 3's PostgreSQL</span>
  <span class="na">data_dir</span><span class="pi">:</span> <span class="s">/var/lib/postgresql/data</span>
  <span class="na">bin_dir</span><span class="pi">:</span> <span class="s">/usr/lib/postgresql/17/bin</span>
  <span class="na">authentication</span><span class="pi">:</span>
    <span class="na">superuser</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cnV2abjbDpbh64e12987wR4mj5kQ3456Y0Qf"</span>  <span class="c1"># Superuser password (provided)</span>
    <span class="na">replication</span><span class="pi">:</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">replicator</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">sad9a23jga8jsuedrwtsskj74567suiuwe23</span>  <span class="c1"># Replication password (provided)</span>
  <span class="na">parameters</span><span class="pi">:</span>
    <span class="na">max_connections</span><span class="pi">:</span> <span class="m">100</span>
    <span class="na">shared_buffers</span><span class="pi">:</span> <span class="s">256MB</span>

<span class="na">tags</span><span class="pi">:</span>
  <span class="na">nofailover</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">noloadbalance</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">clonefrom</span><span class="pi">:</span> <span class="kc">false</span>

</pre></table></code></div></div><h3 id="patroni-certificates"><span class="me-2">Patroni Certificates</span><a href="#patroni-certificates" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Letâ€™s also use a certificate for this, requires a pem</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>sh <span class="nt">-c</span> <span class="s1">'cat /var/lib/postgresql/ssl/server.crt /var/lib/postgresql/ssl/server.key &gt; /var/lib/postgresql/ssl/server.pem'</span>
<span class="nb">sudo chown </span>postgres:postgres /var/lib/postgresql/ssl/server.pem
<span class="nb">sudo chmod </span>600 /var/lib/postgresql/ssl/server.pem
</pre></table></code></div></div><p>We can verify with:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>openssl x509 <span class="nt">-in</span> /var/lib/postgresql/ssl/server.pem <span class="nt">-text</span> <span class="nt">-noout</span>

</pre></table></code></div></div><h3 id="starting-patroni-and-ha-cluster"><span class="me-2">Starting Patroni and HA Cluster</span><a href="#starting-patroni-and-ha-cluster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Restart the service</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="nb">sudo </span>systemctl restart patroni
</pre></table></code></div></div><p>Check logs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>journalctl <span class="nt">-u</span> patroni <span class="nt">-f</span>
</pre></table></code></div></div><p>Should see something like:</p><pre><code class="language-log">Dec 03 22:16:05 postgres-01 patroni[770]: 2024-12-03 22:16:05,399 INFO: no action. I am (postgresql-01), the leader with the lock
Dec 03 22:16:15 postgres-01 patroni[770]: 2024-12-03 22:16:15,399 INFO: no action. I am (postgresql-01), the leader with the lock
</code></pre><p>and</p><pre><code class="language-log">Dec 03 22:16:21 postgres-02 patroni[768]: 2024-12-03 22:16:21,780 INFO: Lock owner: postgresql-01; I am postgresql-02
Dec 03 22:16:21 postgres-02 patroni[768]: 2024-12-03 22:16:21,823 INFO: bootstrap from leader 'postgresql-01' in progress
</code></pre><h3 id="reconfiguring-our-etcd-cluster"><span class="me-2">Reconfiguring our etcd Cluster</span><a href="#reconfiguring-our-etcd-cluster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/etcd/etcd.env
</pre></table></code></div></div><p>Change</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
</pre></table></code></div></div><p>to</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"existing"</span>
</pre></table></code></div></div><p>Do this on all 3 nodes!</p><h3 id="verifying-our-postgres-cluster"><span class="me-2">Verifying Our Postgres Cluster</span><a href="#verifying-our-postgres-cluster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We now have a ha postgres cluster!</p><p>However we donâ€™t always know who the leader is so we canâ€™t use an IP</p><p>We can test the patroni endpoint to see who is leader</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>curl <span class="nt">-k</span> https://192.168.60.103:8008/primary
curl <span class="nt">-k</span> https://192.168.60.104:8008/primary
curl <span class="nt">-k</span> https://192.168.60.105:8008/primary
</pre></table></code></div></div><h3 id="editing-your-pg_hba-after-bootstrapping"><span class="me-2">Editing your pg_hba after bootstrapping</span><a href="#editing-your-pg_hba-after-bootstrapping" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you ever want to see your global config you can with</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>patronictl <span class="nt">-c</span> /etc/patroni/config.yml show-config
</pre></table></code></div></div><p>If you ever want to edit it, you can with:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>patronictl <span class="nt">-c</span> /etc/patroni/config.yml edit-config
</pre></table></code></div></div><p>After saving these will be replicated to all nodes, note you might want to update your boostrap config at some pouint</p><h2 id="ha-proxy"><span class="me-2">HA Proxy</span><a href="#ha-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="installing-ha-proxy"><span class="me-2">Installing HA Proxy</span><a href="#installing-ha-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>this is where ha proxy comes in</p><p>switch nodes</p><p>install ha proxy</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nt">-y</span> <span class="nb">install </span>haproxy
</pre></table></code></div></div><p>Once installed we need to add some config</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/haproxy/haproxy.cfg
</pre></table></code></div></div><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">frontend</span> <span class="n">postgres_frontend</span>
    <span class="n">bind</span> *:<span class="m">5432</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">default_backend</span> <span class="n">postgres_backend</span>

<span class="n">backend</span> <span class="n">postgres_backend</span>
    <span class="n">mode</span> <span class="n">tcp</span>
    <span class="n">option</span> <span class="n">tcp</span>-<span class="n">check</span>
    <span class="n">option</span> <span class="n">httpchk</span> <span class="n">GET</span> /<span class="n">primary</span>  <span class="c"># patroni provides an endpoint to check node roles
</span>    <span class="n">http</span>-<span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="m">200</span>  <span class="c"># expect 200 for the primary node
</span>    <span class="n">timeout</span> <span class="n">connect</span> <span class="m">5</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span> <span class="m">30</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">server</span> <span class="m">30</span><span class="n">s</span>
    <span class="n">server</span> <span class="n">postgresql</span>-<span class="m">01</span> <span class="m">192</span>.<span class="m">168</span>.<span class="m">60</span>.<span class="m">103</span>:<span class="m">5432</span> <span class="n">port</span> <span class="m">8008</span> <span class="n">check</span> <span class="n">check</span>-<span class="n">ssl</span> <span class="n">verify</span> <span class="n">none</span>
    <span class="n">server</span> <span class="n">postgresql</span>-<span class="m">02</span> <span class="m">192</span>.<span class="m">168</span>.<span class="m">60</span>.<span class="m">104</span>:<span class="m">5432</span> <span class="n">port</span> <span class="m">8008</span> <span class="n">check</span> <span class="n">check</span>-<span class="n">ssl</span> <span class="n">verify</span> <span class="n">none</span>
    <span class="n">server</span> <span class="n">postgresql</span>-<span class="m">03</span> <span class="m">192</span>.<span class="m">168</span>.<span class="m">60</span>.<span class="m">105</span>:<span class="m">5432</span> <span class="n">port</span> <span class="m">8008</span> <span class="n">check</span> <span class="n">check</span>-<span class="n">ssl</span> <span class="n">verify</span> <span class="n">none</span>
</pre></table></code></div></div><p>Do this for all 3 nodes</p><h3 id="starting-ha-proxy"><span class="me-2">Starting HA Proxy</span><a href="#starting-ha-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>restart</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl reload haproxy
</pre></table></code></div></div><p>check logs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo tail</span> <span class="nt">-f</span> /var/log/syslog | <span class="nb">grep </span>haproxy
</pre></table></code></div></div><h2 id="keepalived"><span class="me-2">keepalived</span><a href="#keepalived" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="installing-keepalived"><span class="me-2">Installing keepalived</span><a href="#installing-keepalived" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now we need to install keepalived to create a VIP</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>keepalived <span class="nt">-y</span>
</pre></table></code></div></div><h3 id="confuring-keepalived"><span class="me-2">Confuring keepalived</span><a href="#confuring-keepalived" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now we need to apply a configuration file</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/keepalived/keepalived.conf
</pre></table></code></div></div><p>haproxy1</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="n">global_defs</span> {
    <span class="n">enable_script_security</span>
    <span class="n">script_user</span> <span class="n">keepalived_script</span>
}

<span class="n">vrrp_script</span> <span class="n">check_haproxy</span> {
    <span class="n">script</span> <span class="s2">"/etc/keepalived/check_haproxy.sh"</span>
    <span class="n">interval</span> <span class="m">2</span>
    <span class="n">fall</span> <span class="m">3</span>
    <span class="n">rise</span> <span class="m">2</span>
}

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> {
    <span class="n">state</span> <span class="n">MASTER</span>
    <span class="n">interface</span> <span class="n">eth0</span> <span class="c"># update with your nic
</span>    <span class="n">virtual_router_id</span> <span class="m">51</span>
    <span class="n">priority</span> <span class="m">100</span>
    <span class="n">advert_int</span> <span class="m">1</span>
    <span class="n">authentication</span> {
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="n">tDHjh7by</span> <span class="c"># change
</span>    }
    <span class="n">virtual_ipaddress</span> {
        <span class="m">192</span>.<span class="m">168</span>.<span class="m">60</span>.<span class="m">110</span>
    }
    <span class="n">track_script</span> {
        <span class="n">check_haproxy</span>
    }
}

</pre></table></code></div></div><p>haproxy2</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="n">global_defs</span> {
    <span class="n">enable_script_security</span>
    <span class="n">script_user</span> <span class="n">keepalived_script</span>
}

<span class="n">vrrp_script</span> <span class="n">check_haproxy</span> {
    <span class="n">script</span> <span class="s2">"/etc/keepalived/check_haproxy.sh"</span>
    <span class="n">interval</span> <span class="m">2</span>
    <span class="n">fall</span> <span class="m">3</span>
    <span class="n">rise</span> <span class="m">2</span>
}

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> {
    <span class="n">state</span> <span class="n">BACKUP</span>
    <span class="n">interface</span> <span class="n">eth0</span> <span class="c"># update with your nic
</span>    <span class="n">virtual_router_id</span> <span class="m">51</span>
    <span class="n">priority</span> <span class="m">90</span>
    <span class="n">advert_int</span> <span class="m">1</span>
    <span class="n">authentication</span> {
        <span class="n">auth_type</span> <span class="n">PASS</span> <span class="c"># change
</span>        <span class="n">auth_pass</span> <span class="n">tDHjh7by</span> <span class="c"># change
</span>    }
    <span class="n">virtual_ipaddress</span> {
        <span class="m">192</span>.<span class="m">168</span>.<span class="m">60</span>.<span class="m">110</span>
    }
    <span class="n">track_script</span> {
        <span class="n">check_haproxy</span>
    }
}
</pre></table></code></div></div><p>haproxy3</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="n">global_defs</span> {
    <span class="n">enable_script_security</span>
    <span class="n">script_user</span> <span class="n">keepalived_script</span>
}

<span class="n">vrrp_script</span> <span class="n">check_haproxy</span> {
    <span class="n">script</span> <span class="s2">"/etc/keepalived/check_haproxy.sh"</span>
    <span class="n">interval</span> <span class="m">2</span>
    <span class="n">fall</span> <span class="m">3</span>
    <span class="n">rise</span> <span class="m">2</span>
}

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> {
    <span class="n">state</span> <span class="n">BACKUP</span>
    <span class="n">interface</span> <span class="n">eth0</span> <span class="c"># update with your nic
</span>    <span class="n">virtual_router_id</span> <span class="m">51</span>
    <span class="n">priority</span> <span class="m">80</span>
    <span class="n">advert_int</span> <span class="m">1</span>
    <span class="n">authentication</span> {
        <span class="n">auth_type</span> <span class="n">PASS</span> <span class="c"># change
</span>        <span class="n">auth_pass</span> <span class="n">tDHjh7by</span> <span class="c"># change
</span>    }
    <span class="n">virtual_ipaddress</span> {
        <span class="m">192</span>.<span class="m">168</span>.<span class="m">60</span>.<span class="m">110</span>
    }
    <span class="n">track_script</span> {
        <span class="n">check_haproxy</span>
    }
}
</pre></table></code></div></div><p>Create a check script on each</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/keepalived/check_haproxy.sh
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Define the port to check (e.g., HAProxy frontend port)</span>
<span class="nv">PORT</span><span class="o">=</span>5432

<span class="c"># Check if HAProxy is running</span>
<span class="k">if</span> <span class="o">!</span> pidof haproxy <span class="o">&gt;</span> /dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"HAProxy is not running"</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Check if HAProxy is listening on the expected port</span>
<span class="k">if</span> <span class="o">!</span> ss <span class="nt">-ltn</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">":</span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"HAProxy is not listening on port </span><span class="k">${</span><span class="nv">PORT</span><span class="k">}</span><span class="s2">"</span>
    <span class="nb">exit </span>2
<span class="k">fi</span>

<span class="c"># All checks passed</span>
<span class="nb">exit </span>0
</pre></table></code></div></div><p>we need to add a user to execute these scripts</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>useradd <span class="nt">-r</span> <span class="nt">-s</span> /bin/false keepalived_script
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">sudo chmod</span> +x /etc/keepalived/check_haproxy.sh
<span class="nb">sudo chown </span>keepalived_script:keepalived_script /etc/keepalived/check_haproxy.sh
<span class="nb">sudo chmod </span>700 /etc/keepalived/check_haproxy.sh
</pre></table></code></div></div><h3 id="starting-keepalived"><span class="me-2">Starting keepalived</span><a href="#starting-keepalived" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart keepalived
</pre></table></code></div></div><h3 id="verifying-keepalived"><span class="me-2">Verifying keepalived</span><a href="#verifying-keepalived" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Check logs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>journalctl <span class="nt">-u</span> keepalived <span class="nt">-f</span>
</pre></table></code></div></div><p>we should not be able to ping the VIP</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ping 192.168.60.110
</pre></table></code></div></div><h2 id="pgadmin"><span class="me-2">PGAdmin</span><a href="#pgadmin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="connecting-with-pgadmin"><span class="me-2">Connecting with PGAdmin</span><a href="#connecting-with-pgadmin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Connected with a client</p><p><a href="https://www.pgadmin.org/">https://www.pgadmin.org/</a></p><p>Connect to your VIP <code class="language-plaintext highlighter-rouge">192.168.60.110</code> and use the <code class="language-plaintext highlighter-rouge">postgres</code> user and password.</p><h3 id="adding-data"><span class="me-2">Adding Data</span><a href="#adding-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Create a table with data</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1">-- Create a table for Nintendo characters</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nintendo_characters</span> <span class="p">(</span>
    <span class="n">character_id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="c1">-- Unique identifier for each character</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>       <span class="c1">-- Name of the character</span>
    <span class="n">game_series</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>         <span class="c1">-- Game series the character belongs to</span>
    <span class="n">debut_year</span> <span class="nb">INT</span><span class="p">,</span>                  <span class="c1">-- Year the character debuted</span>
    <span class="n">description</span> <span class="nb">TEXT</span><span class="p">,</span>                <span class="c1">-- Brief description of the character</span>
    <span class="n">is_playable</span> <span class="nb">BOOLEAN</span> <span class="k">DEFAULT</span> <span class="k">TRUE</span> <span class="c1">-- Whether the character is playable</span>
<span class="p">);</span>

<span class="c1">-- Insert some example characters</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">nintendo_characters</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">game_series</span><span class="p">,</span> <span class="n">debut_year</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">is_playable</span><span class="p">)</span>
<span class="k">VALUES</span>
    <span class="p">(</span><span class="s1">'Mario'</span><span class="p">,</span> <span class="s1">'Super Mario'</span><span class="p">,</span> <span class="mi">1981</span><span class="p">,</span> <span class="s1">'The iconic plumber and hero of the Mushroom Kingdom.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Link'</span><span class="p">,</span> <span class="s1">'The Legend of Zelda'</span><span class="p">,</span> <span class="mi">1986</span><span class="p">,</span> <span class="s1">'A courageous hero tasked with saving Hyrule.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Samus Aran'</span><span class="p">,</span> <span class="s1">'Metroid'</span><span class="p">,</span> <span class="mi">1986</span><span class="p">,</span> <span class="s1">'A bounty hunter equipped with a powerful Power Suit.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Donkey Kong'</span><span class="p">,</span> <span class="s1">'Donkey Kong'</span><span class="p">,</span> <span class="mi">1981</span><span class="p">,</span> <span class="s1">'A powerful gorilla and protector of the jungle.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Princess Zelda'</span><span class="p">,</span> <span class="s1">'The Legend of Zelda'</span><span class="p">,</span> <span class="mi">1986</span><span class="p">,</span> <span class="s1">'The princess of Hyrule and possessor of the Triforce of Wisdom.'</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Bowser'</span><span class="p">,</span> <span class="s1">'Super Mario'</span><span class="p">,</span> <span class="mi">1985</span><span class="p">,</span> <span class="s1">'The King of the Koopas and Marios arch-nemesis.'</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Kirby'</span><span class="p">,</span> <span class="s1">'Kirby'</span><span class="p">,</span> <span class="mi">1992</span><span class="p">,</span> <span class="s1">'A pink puffball with the ability to inhale enemies and copy their powers.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Pikachu'</span><span class="p">,</span> <span class="s1">'PokÃ©mon'</span><span class="p">,</span> <span class="mi">1996</span><span class="p">,</span> <span class="s1">'An Electric-type PokÃ©mon and mascot of the PokÃ©mon series.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Fox McCloud'</span><span class="p">,</span> <span class="s1">'Star Fox'</span><span class="p">,</span> <span class="mi">1993</span><span class="p">,</span> <span class="s1">'A skilled pilot and leader of the Star Fox team.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Captain Falcon'</span><span class="p">,</span> <span class="s1">'F-Zero'</span><span class="p">,</span> <span class="mi">1990</span><span class="p">,</span> <span class="s1">'A bounty hunter and expert racer known for his Falcon Punch.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>

<span class="c1">-- Select all rows to verify the table creation and data insertion</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nintendo_characters</span><span class="p">;</span>

</pre></table></code></div></div><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nintendo_characters</span><span class="p">;</span>
</pre></table></code></div></div><p>insert more characters</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">-- Insert additional Nintendo characters into the table</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">nintendo_characters</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">game_series</span><span class="p">,</span> <span class="n">debut_year</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">is_playable</span><span class="p">)</span>
<span class="k">VALUES</span>
    <span class="p">(</span><span class="s1">'Yoshi'</span><span class="p">,</span> <span class="s1">'Super Mario'</span><span class="p">,</span> <span class="mi">1990</span><span class="p">,</span> <span class="s1">'A friendly green dinosaur and Marios trusted companion.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Luigi'</span><span class="p">,</span> <span class="s1">'Super Mario'</span><span class="p">,</span> <span class="mi">1983</span><span class="p">,</span> <span class="s1">'Marios younger brother and a skilled ghost hunter.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'King Dedede'</span><span class="p">,</span> <span class="s1">'Kirby'</span><span class="p">,</span> <span class="mi">1992</span><span class="p">,</span> <span class="s1">'The self-proclaimed king of Dream Land and occasional ally of Kirby.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Meta Knight'</span><span class="p">,</span> <span class="s1">'Kirby'</span><span class="p">,</span> <span class="mi">1993</span><span class="p">,</span> <span class="s1">'A mysterious swordsman who often challenges Kirby.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Marth'</span><span class="p">,</span> <span class="s1">'Fire Emblem'</span><span class="p">,</span> <span class="mi">1990</span><span class="p">,</span> <span class="s1">'A legendary hero and prince from the Fire Emblem series.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Ness'</span><span class="p">,</span> <span class="s1">'EarthBound'</span><span class="p">,</span> <span class="mi">1994</span><span class="p">,</span> <span class="s1">'A young boy with psychic powers and a bat-wielding hero.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Jigglypuff'</span><span class="p">,</span> <span class="s1">'PokÃ©mon'</span><span class="p">,</span> <span class="mi">1996</span><span class="p">,</span> <span class="s1">'A Balloon PokÃ©mon known for its singing abilities.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Villager'</span><span class="p">,</span> <span class="s1">'Animal Crossing'</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="s1">'A customizable character from the Animal Crossing series.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Isabelle'</span><span class="p">,</span> <span class="s1">'Animal Crossing'</span><span class="p">,</span> <span class="mi">2012</span><span class="p">,</span> <span class="s1">'A cheerful assistant who helps manage your town.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'Ganondorf'</span><span class="p">,</span> <span class="s1">'The Legend of Zelda'</span><span class="p">,</span> <span class="mi">1998</span><span class="p">,</span> <span class="s1">'The King of Evil and nemesis of Link.'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>

</pre></table></code></div></div><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">nintendo_characters</span><span class="p">;</span>
</pre></table></code></div></div><p>If you want to clean this data up, you can <code class="language-plaintext highlighter-rouge">DROP</code> the table</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">-- Drop the nintendo_characters table if it exists</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">nintendo_characters</span><span class="p">;</span>
</pre></table></code></div></div><h2 id="troubleshooting"><span class="me-2">Troubleshooting</span><a href="#troubleshooting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Reset all data but certs and start over</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl stop patroni
<span class="nb">sudo </span>systemctl stop etcd
<span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/lib/etcd/
<span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/lib/postgresql/data/
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/postgresql/data
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /var/lib/etcd/
<span class="nb">sudo chown </span>etcd:etcd /var/lib/etcd/
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/ca.crt
<span class="nb">sudo </span>setfacl <span class="nt">-m</span> u:postgres:r /etc/etcd/ssl/etcd-node<span class="k">*</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl start etcd
<span class="nb">sudo </span>systemctl start patroni
</pre></table></code></div></div><h2 id="join-the-conversation"><span class="me-2">Join the conversation</span><a href="#join-the-conversation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="twitter-tweet" data-dnt="true" data-theme="dark"><p lang="en" dir="ltr">Today, I teach you how you can self-host a production-ready PostgreSQL cluster. I&#39;ve even included all of the copy pasta commands!<a href="https://t.co/OGHUGfDEs2">https://t.co/OGHUGfDEs2</a> <a href="https://t.co/9NWtYcWcO6">pic.twitter.com/9NWtYcWcO6</a></p>&mdash; Techno Tim (@TechnoTimLive) <a href="https://twitter.com/TechnoTimLive/status/1865482821151736011?ref_src=twsrc%5Etfw">December 7, 2024</a></blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="links"><span class="me-2">Links</span><a href="#links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>ðŸ›ï¸ Check out the new Merch Shop at <a href="https://l.technotim.live/shop">https://l.technotim.live/shop</a></p><p>âš™ï¸ See all the hardware I recommend at <a href="https://l.technotim.live/gear">https://l.technotim.live/gear</a></p><p>ðŸš€ Donâ€™t forget to check out the <a href="https://l.technotim.live/quick-start">ðŸš€Launchpad repo</a> with all of the quick start source files</p><p>ðŸ¤ Support me and <a href="/sponsor">help keep this site ad-free!</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/self-hosted/">self-hosted</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/postgresql/" class="post-tag no-text-decoration" >postgresql</a> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PostgresSQL%20Clustering%20the%20hard%20way...%20-%20Techno%20Tim&url=https%3A%2F%2Ftechnotim.live%2Fposts%2Fpostgresql-high-availability%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=PostgresSQL%20Clustering%20the%20hard%20way...%20-%20Techno%20Tim&u=https%3A%2F%2Ftechnotim.live%2Fposts%2Fpostgresql-high-availability%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftechnotim.live%2Fposts%2Fpostgresql-high-availability%2F&text=PostgresSQL%20Clustering%20the%20hard%20way...%20-%20Techno%20Tim" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftechnotim.live%2Fposts%2Fpostgresql-high-availability%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <script defer type="module" src="https://cdn.jsdelivr.net/npm/@justinribeiro/share-to-mastodon/+esm"></script> <button class="btn text-start" data-bs-toggle="tooltip" data-bs-placement="top" title="Mastodon" aria-label="Mastodon"> <share-to-mastodon class="share-mastodon" message="PostgresSQL%20Clustering%20the%20hard%20way...%20-%20Techno%20Tim" url="https%3A%2F%2Ftechnotim.live%2Fposts%2Fpostgresql-high-availability%2F"customInstanceList="[{&quot;label&quot;:&quot;mastodon.social&quot;,&quot;link&quot;:&quot;https://mastodon.social/&quot;},{&quot;label&quot;:&quot;mastodon.online&quot;,&quot;link&quot;:&quot;https://mastodon.online/&quot;},{&quot;label&quot;:&quot;fosstodon.org&quot;,&quot;link&quot;:&quot;https://fosstodon.org/&quot;},{&quot;label&quot;:&quot;photog.social&quot;,&quot;link&quot;:&quot;https://photog.social/&quot;}]" > <i class="fa-fw fa-brands fa-mastodon"></i> </share-to-mastodon> </button> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/traefik-3-docker-certificates/">Traefik 3 and FREE Wildcard Certificates with Docker</a><li class="text-truncate lh-lg"> <a href="/posts/traefik-portainer-ssl/">Put Wildcard Certificates and SSL on EVERYTHING</a><li class="text-truncate lh-lg"> <a href="/posts/authelia-traefik/">2 Factor Auth and Single Sign on with Authelia</a><li class="text-truncate lh-lg"> <a href="/posts/grafana-loki/">Meet Grafana LOKI, a Log Aggregation System for Everything</a><li class="text-truncate lh-lg"> <a href="/posts/jekyll-docs-site/">Meet Jekyll - The Static Site Generator</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/hardware/">hardware</a> <a class="post-tag btn btn-outline-primary" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/rancher/">rancher</a> <a class="post-tag btn btn-outline-primary" href="/tags/self-hosted/">self-hosted</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/portainer/">portainer</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/k3s/">k3s</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/hl15-review/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1700658000" data-df="ll" > Nov 22, 2023 </time><h4 class="pt-0 my-2">EVERYTHING You Should Know About the HL15</h4><div class="text-muted"><p> The HL15 from 45Drives is here. It brings a lot of unique features and was built and designed with the HomeLab community in mind. In this in-depth review weâ€™ll cover everything you want to know a...</p></div></div></a></article><article class="col"> <a href="/posts/first-11-things-proxmox/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1606572000" data-df="ll" > Nov 28, 2020 </time><h4 class="pt-0 my-2">Before I do anything on Proxmox, I do this first...</h4><div class="text-muted"><p> After setting up my Proxmox servers, there are a few things I do before I use them for their intended purpose.This ranges from updates, to storage, to networking and VLANS, to uploading ISOs, to cl...</p></div></div></a></article><article class="col"> <a href="/posts/NUT-server-guide/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1632582000" data-df="ll" > Sep 25, 2021 </time><h4 class="pt-0 my-2">Network UPS Tools (NUT) Ultimate Guide</h4><div class="text-muted"><p> Meet NUT Server, or Network UPS Tools.Itâ€™s an open UPS networking monitoring tool that runs on many different operating systems and processors.This means you can run the server on Linux, MacOS, or ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/hexos-beta/" class="btn btn-outline-primary" aria-label="Older" ><p>I tried the HexOS Beta. Here's how it went.</p></a> <a href="/posts/linux-workstation/" class="btn btn-outline-primary" aria-label="Newer" ><p>Building My ULTIMATE Linux Workstation</p></a></nav><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'timothystewart6/techno-tim.github.io', 'data-repo-id': 'MDEwOlJlcG9zaXRvcnkyNTQ3ODQ3Nzk', 'data-category': 'Comments', 'data-category-id': 'DIC_kwDODy-1C84CSN7z', 'data-mapping': 'pathname', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>Â© <time>2025</time> <a href="https://l.technotim.live/twitter">Techno Tim</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p><a href="/sponsor/">ðŸ¤ Help keep this ad-free!</href> &nbsp; &nbsp;<a href="https://l.technotim.live/shop">ðŸ›ï¸ Check out the new merch shop!</href></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/hardware/">hardware</a> <a class="post-tag btn btn-outline-primary" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/rancher/">rancher</a> <a class="post-tag btn btn-outline-primary" href="/tags/self-hosted/">self-hosted</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/portainer/">portainer</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/k3s/">k3s</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
