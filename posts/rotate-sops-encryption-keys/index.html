<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Rotating your Encryption Keys and Updating your Secrets with SOPS" /><meta property="og:locale" content="en" /><meta name="description" content="If you’ve been encrypting your secrets with SOPS and Age you know how useful it is to keep your secrets safe from prying eyes. If you’re not familiar with encrypting your secrets with SOPS and Age, I highly recommend checking out a post I did a while back that shows you how easy it is to encrypt your secrets and even hide them in plain sight in a Git repo.I am happy (and relieved) that I started doing this for all of my secrets." /><meta property="og:description" content="If you’ve been encrypting your secrets with SOPS and Age you know how useful it is to keep your secrets safe from prying eyes. If you’re not familiar with encrypting your secrets with SOPS and Age, I highly recommend checking out a post I did a while back that shows you how easy it is to encrypt your secrets and even hide them in plain sight in a Git repo.I am happy (and relieved) that I started doing this for all of my secrets." /><link rel="canonical" href="https://technotim.live/posts/rotate-sops-encryption-keys/" /><meta property="og:url" content="https://technotim.live/posts/rotate-sops-encryption-keys/" /><meta property="og:site_name" content="Techno Tim" /><meta property="og:image" content="https://technotim.live/assets/img/headers/museum-hieroglyphics.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-05T09:00:00-06:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://technotim.live/assets/img/headers/museum-hieroglyphics.webp" /><meta property="twitter:title" content="Rotating your Encryption Keys and Updating your Secrets with SOPS" /><meta name="twitter:site" content="@technotimlive" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-22T15:25:04-06:00","datePublished":"2023-03-05T09:00:00-06:00","description":"If you’ve been encrypting your secrets with SOPS and Age you know how useful it is to keep your secrets safe from prying eyes. If you’re not familiar with encrypting your secrets with SOPS and Age, I highly recommend checking out a post I did a while back that shows you how easy it is to encrypt your secrets and even hide them in plain sight in a Git repo.I am happy (and relieved) that I started doing this for all of my secrets.","headline":"Rotating your Encryption Keys and Updating your Secrets with SOPS","image":{"lqip":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAf/AABEIAAUACgMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APyS1v8AaHutK/Zk8MaBpfgfwzYrP8PfD1veajHb2zanNeaFNHdaZqkF8+nm7s7yK5mmllMVwwn37Xwq8/5gZZ4X0q3ibm+ZV+IMzq1XxLj6mHpt1lSw1HGSqU8Xho01jPZyp1qUYUr8kXGEbWdz/VbF8Y1qPB+WuGAoxhTyai501OKVWdKhSdGbl7BuLpVL1Vu+d3TRSsf+Cwf7XOlWNnpdlqfhqKz021t7C0jOjQMY7azhS3gQttG4pFGi5xzjNfa/8S0cLPVcQ8SQT1UIYiioQT2jFOm2oxWkbtuyV23qfBy8X8a5ScuHsolJybcpSxDlJt6ttNK7erslr0R//9k=","url":"https://technotim.live/assets/img/headers/museum-hieroglyphics.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://technotim.live/posts/rotate-sops-encryption-keys/"},"url":"https://technotim.live/posts/rotate-sops-encryption-keys/"}</script><title>Rotating your Encryption Keys and Updating your Secrets with SOPS | Techno Tim</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Techno Tim"><meta name="application-name" content="Techno Tim"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://avatars.githubusercontent.com/u/1322205?s=400&u=5b4f2219006577dc0426007fe5a02391c4899677&v=4" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">Techno Tim</a></h1><p class="site-subtitle fst-italic mb-0">Engineer. Builder. Creator. | From Code to Cloud</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/shop/" class="nav-link"> <i class="fa-fw fas fa-bag-shopping"></i> <span>MERCH</span> </a><li class="nav-item"> <a href="/sponsor/" class="nav-link"> <i class="fa-fw fas fa-handshake"></i> <span>SPONSOR</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://l.technotim.live/links" aria-label="links" target="_blank" rel="noopener noreferrer" > <i class="fa-solid fa-link"></i> </a> <a href="https://twitter.com/technotimlive" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="https://l.technotim.live/github" aria-label="github-custom" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Rotating your Encryption Keys and Updating your Secrets with SOPS</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Rotating your Encryption Keys and Updating your Secrets with SOPS</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1678028400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 5, 2023 </time> </span> <span> Updated <time data-ts="1708637104" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 22, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/img/headers/museum-hieroglyphics.webp" class="popup img-link preview-img blur"><img data-src="/assets/img/headers/museum-hieroglyphics.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAf/AABEIAAUACgMBEQACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APyS1v8AaHutK/Zk8MaBpfgfwzYrP8PfD1veajHb2zanNeaFNHdaZqkF8+nm7s7yK5mmllMVwwn37Xwq8/5gZZ4X0q3ibm+ZV+IMzq1XxLj6mHpt1lSw1HGSqU8Xho01jPZyp1qUYUr8kXGEbWdz/VbF8Y1qPB+WuGAoxhTyai501OKVWdKhSdGbl7BuLpVL1Vu+d3TRSsf+Cwf7XOlWNnpdlqfhqKz021t7C0jOjQMY7azhS3gQttG4pFGi5xzjNfa/8S0cLPVcQ8SQT1UIYiioQT2jFOm2oxWkbtuyV23qfBy8X8a5ScuHsolJybcpSxDlJt6ttNK7erslr0R//9k="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://l.technotim.live/twitter">Techno Tim</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="648 words" > <em>3 min</em> read</span></div></div></header><div class="content"><p>If you’ve been encrypting your secrets with SOPS and Age you know how useful it is to keep your secrets safe from prying eyes. If you’re not familiar with encrypting your secrets with SOPS and Age, I highly recommend checking out a post I did a while back that shows you how easy it is to <a href="/posts/secret-encryption-sops">encrypt your secrets</a> and even hide them in plain sight in a Git repo.I am happy (and relieved) that I started doing this for all of my secrets.</p><p>This works great, until you need to rotate your encryption key that’s used to encrypt your secrets. I use <a href="/posts/flux-devops-gitops">FLUX for GitOps</a> which helps me deliver changes to my Kubernetes cluster via code and since I can commit my infrastructure, I can also commit my secrets as code too (SOPS, or Secrets Operations).This means that all of my secret files (typically <code class="language-plaintext highlighter-rouge">secret.sops.yaml</code>) are all encrypted using my key.But what happens when I need to change the key, either for good security hygiene or because it was compromised? The short answer is, there’s no easy way other than writing a little bit of code.</p><h3 id="scripting-it-with-bash"><span class="me-2">Scripting it with Bash</span><a href="#scripting-it-with-bash" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First you’ll need to generate a new <code class="language-plaintext highlighter-rouge">age</code> file with</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>age-keygen <span class="nt">-o</span> age.agekey
</pre></table></code></div></div><p>This will output a <code class="language-plaintext highlighter-rouge">age.agekey</code> file.Take note of this location.</p><p>Then you’ll want to execute this script in the folder where you have secrets that need to be updated.</p><p>This script isn’t anything ground breaking but hopefully it will help you update all of your secrets without having to go and manually change them yourself.</p><div file="sops_rotate_key.sh" class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="sops_rotate_key.sh"><i class="far fa-file-code fa-fw"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Define the paths to the old/current and new age key files</span>
<span class="nv">SOPS_AGE_KEY_FILE</span><span class="o">=</span>~/.config/sops/age/keys.txt
<span class="nv">SOPS_AGE_KEY_FILE_NEW</span><span class="o">=</span>~/.config/sops/age/age.agekey

<span class="c"># Define the commands to decrypt and encrypt the file</span>
<span class="nv">DECRYPT_COMMAND</span><span class="o">=</span><span class="s2">"sops --decrypt --age </span><span class="se">\$</span><span class="s2">(cat </span><span class="nv">$SOPS_AGE_KEY_FILE</span><span class="s2"> |grep -oP </span><span class="se">\"</span><span class="s2">public key: </span><span class="se">\K</span><span class="s2">(.*)</span><span class="se">\"</span><span class="s2">) --encrypted-regex '^(data|stringData)</span><span class="nv">$'</span><span class="s2"> --in-place"</span>
<span class="nv">ENCRYPT_COMMAND</span><span class="o">=</span><span class="s2">"sops --encrypt --age </span><span class="se">\$</span><span class="s2">(cat </span><span class="nv">$SOPS_AGE_KEY_FILE_NEW</span><span class="s2"> |grep -oP </span><span class="se">\"</span><span class="s2">public key: </span><span class="se">\K</span><span class="s2">(.*)</span><span class="se">\"</span><span class="s2">) --encrypted-regex '^(data|stringData)</span><span class="nv">$'</span><span class="s2"> --in-place"</span>

<span class="c"># Find all the *.sops.yaml files recursively in the current directory and apply the decrypt and encrypt commands to them</span>
find <span class="nb">.</span> <span class="nt">-name</span> <span class="s2">"*.sops.yaml"</span> <span class="nt">-type</span> f <span class="nt">-print0</span> | <span class="k">while </span><span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> <span class="nt">-r</span> <span class="nt">-d</span> <span class="s1">''</span> file<span class="p">;</span> <span class="k">do
  </span><span class="nb">eval</span> <span class="s2">"</span><span class="nv">$DECRYPT_COMMAND</span><span class="s2"> </span><span class="nv">$file</span><span class="s2">"</span>
  <span class="nb">eval</span> <span class="s2">"</span><span class="nv">$ENCRYPT_COMMAND</span><span class="s2"> </span><span class="nv">$file</span><span class="s2">"</span>
<span class="k">done</span>
</pre></table></code></div></div><p>It works like this:</p><ul><li><code class="language-plaintext highlighter-rouge">SOPS_AGE_KEY_FILE</code> is the path to your existing <code class="language-plaintext highlighter-rouge">keys.txt</code> or <code class="language-plaintext highlighter-rouge">age.agekey</code> file<li><code class="language-plaintext highlighter-rouge">SOPS_AGE_KEY_FILE_NEW</code> is the path to your new <code class="language-plaintext highlighter-rouge">age.agekey</code> file.<li>It will look for files matching <code class="language-plaintext highlighter-rouge">*.sops.yaml</code> recursively and then decrypt the file using the old key, and encrypt it using the new key.</ul><p>After running this script you should see all of your secrets now encrypted with the new key! You can now replace your old key file with your new one so that <code class="language-plaintext highlighter-rouge">SOPS_AGE_KEY_FILE</code> is referencing. You should test decrypting your secrets before saving them.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sops <span class="nt">--decrypt</span> <span class="nt">--age</span> <span class="si">$(</span><span class="nb">cat</span> <span class="nv">$SOPS_AGE_KEY_FILE</span> |grep <span class="nt">-oP</span> <span class="s2">"public key: </span><span class="se">\K</span><span class="s2">(.*)"</span><span class="si">)</span> <span class="nt">--encrypted-regex</span> <span class="s1">'^(data|stringData)$'</span> secret.sops.yaml
</pre></table></code></div></div><h2 id="updating-your-flux-secret-in-kubernetes"><span class="me-2">Updating your FLUX Secret in Kubernetes</span><a href="#updating-your-flux-secret-in-kubernetes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you are able to see the decrypted secret, you are all set as far as the ket goes.Another thing you’ll need to do is delete your old secret in Kubernetes and replace it with this new one so that your secrets can be decrypted in your cluster!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kubectl delete <span class="nt">-n</span> flux-system secrets sops-age
</pre></table></code></div></div><p>Then create new secret from the new file</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">cat </span>age.agekey |
kubectl create secret generic sops-age <span class="se">\</span>
<span class="nt">--namespace</span><span class="o">=</span>flux-system <span class="se">\</span>
<span class="nt">--from-file</span><span class="o">=</span>age.agekey<span class="o">=</span>/dev/stdin
</pre></table></code></div></div><p>Now you should be all set! Be sure to keep your new <code class="language-plaintext highlighter-rouge">age.agekey</code> somewhere safe.</p><h2 id="join-the-conversation"><span class="me-2">Join the conversation</span><a href="#join-the-conversation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="twitter-tweet" data-dnt="true" data-theme="dark"><p lang="en" dir="ltr">I wrote up a quick post on how to rotate your SOPS encryption key and update all of your secrets at once! <br /><br />Great if you&#39;re using SOPS with Kubernetes.<a href="https://t.co/iME1iS4Kpl">https://t.co/iME1iS4Kpl</a></p>&mdash; Techno Tim (@TechnoTimLive) <a href="https://twitter.com/TechnoTimLive/status/1632596441293103106?ref_src=twsrc%5Etfw">March 6, 2023</a></blockquote><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="links"><span class="me-2">Links</span><a href="#links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>🛍️ Check out the new Merch Shop at <a href="https://l.technotim.live/shop">https://l.technotim.live/shop</a></p><p>⚙️ See all the hardware I recommend at <a href="https://l.technotim.live/gear">https://l.technotim.live/gear</a></p><p>🚀 Don’t forget to check out the <a href="https://l.technotim.live/quick-start">🚀Launchpad repo</a> with all of the quick start source files</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/utilities/">utilities</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/sops/" class="post-tag no-text-decoration" >sops</a> <a href="/tags/age/" class="post-tag no-text-decoration" >age</a> <a href="/tags/flux/" class="post-tag no-text-decoration" >flux</a> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Rotating%20your%20Encryption%20Keys%20and%20Updating%20your%20Secrets%20with%20SOPS%20-%20Techno%20Tim&url=https%3A%2F%2Ftechnotim.live%2Fposts%2Frotate-sops-encryption-keys%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Rotating%20your%20Encryption%20Keys%20and%20Updating%20your%20Secrets%20with%20SOPS%20-%20Techno%20Tim&u=https%3A%2F%2Ftechnotim.live%2Fposts%2Frotate-sops-encryption-keys%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftechnotim.live%2Fposts%2Frotate-sops-encryption-keys%2F&text=Rotating%20your%20Encryption%20Keys%20and%20Updating%20your%20Secrets%20with%20SOPS%20-%20Techno%20Tim" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftechnotim.live%2Fposts%2Frotate-sops-encryption-keys%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <script defer type="module" src="https://cdn.jsdelivr.net/npm/@justinribeiro/share-to-mastodon/+esm"></script> <button class="btn text-start" data-bs-toggle="tooltip" data-bs-placement="top" title="Mastodon" aria-label="Mastodon"> <share-to-mastodon class="share-mastodon" message="Rotating%20your%20Encryption%20Keys%20and%20Updating%20your%20Secrets%20with%20SOPS%20-%20Techno%20Tim" url="https%3A%2F%2Ftechnotim.live%2Fposts%2Frotate-sops-encryption-keys%2F"customInstanceList="[{&quot;label&quot;:&quot;mastodon.social&quot;,&quot;link&quot;:&quot;https://mastodon.social/&quot;},{&quot;label&quot;:&quot;mastodon.online&quot;,&quot;link&quot;:&quot;https://mastodon.online/&quot;},{&quot;label&quot;:&quot;fosstodon.org&quot;,&quot;link&quot;:&quot;https://fosstodon.org/&quot;},{&quot;label&quot;:&quot;photog.social&quot;,&quot;link&quot;:&quot;https://photog.social/&quot;}]" > <i class="fa-fw fa-brands fa-mastodon"></i> </share-to-mastodon> </button> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/traefik-3-docker-certificates/">Traefik 3 and FREE Wildcard Certificates with Docker</a><li class="text-truncate lh-lg"> <a href="/posts/traefik-portainer-ssl/">Put Wildcard Certificates and SSL on EVERYTHING</a><li class="text-truncate lh-lg"> <a href="/posts/authelia-traefik/">2 Factor Auth and Single Sign on with Authelia</a><li class="text-truncate lh-lg"> <a href="/posts/grafana-loki/">Meet Grafana LOKI, a Log Aggregation System for Everything</a><li class="text-truncate lh-lg"> <a href="/posts/jekyll-docs-site/">Meet Jekyll - The Static Site Generator</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/hardware/">hardware</a> <a class="post-tag btn btn-outline-primary" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/rancher/">rancher</a> <a class="post-tag btn btn-outline-primary" href="/tags/self-hosted/">self-hosted</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/portainer/">portainer</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/k3s/">k3s</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/secret-encryption-sops/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1664632800" data-df="ll" > Oct 1, 2022 </time><h4 class="pt-0 my-2">Encrypt Your Sensitive Information Before Storing It - Encrypting with Mozilla SOPS and AGE</h4><div class="text-muted"><p> Committing secrets to your Git Repo can expose information like passwords, access tokens, and other types of sensitive information.Some might think that committing secrets to a private Git Repo is ...</p></div></div></a></article><article class="col"> <a href="/posts/flux-devops-gitops/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1652446800" data-df="ll" > May 13, 2022 </time><h4 class="pt-0 my-2">The FASTEST way to deploy apps to Kubernetes - GitOps with FLUX</h4><div class="text-muted"><p> I think I found the perfect GitOps and DevOps toolkit with FluxCD and Kubernetes.Flux is an open source GitOps solution that helps your deploy app and infrastructure with automation.It can monitor ...</p></div></div></a></article><article class="col"> <a href="/posts/update-flux/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1675472400" data-df="ll" > Feb 3, 2023 </time><h4 class="pt-0 my-2">Updating Flux Installation Using the Latest Binary from CLI</h4><div class="text-muted"><p> What is Flux? Flux is a tool for keeping Kubernetes clusters in sync with sources of configuration (like Git repositories), and automating updates to configuration when there is new code to deploy...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/vlan-firewall-unifi/" class="btn btn-outline-primary" aria-label="Older" ><p>Configuring VLANs, Firewall Rules, and WiFi Networks - UniFi Network Application</p></a> <a href="/posts/terraform-cloudflare-github/" class="btn btn-outline-primary" aria-label="Newer" ><p>Automate Cloudflare with Terraform and GitHub Actions! - Terraform Tutorial for Beginners</p></a></nav><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'timothystewart6/techno-tim.github.io', 'data-repo-id': 'MDEwOlJlcG9zaXRvcnkyNTQ3ODQ3Nzk', 'data-category': 'Comments', 'data-category-id': 'DIC_kwDODy-1C84CSN7z', 'data-mapping': 'pathname', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://l.technotim.live/twitter">Techno Tim</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p><a href="/sponsor/">🤝 Help keep this ad-free!</href> &nbsp; &nbsp;<a href="https://l.technotim.live/shop">🛍️ Check out the new merch shop!</href></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/hardware/">hardware</a> <a class="post-tag btn btn-outline-primary" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/rancher/">rancher</a> <a class="post-tag btn btn-outline-primary" href="/tags/self-hosted/">self-hosted</a> <a class="post-tag btn btn-outline-primary" href="/tags/proxmox/">proxmox</a> <a class="post-tag btn btn-outline-primary" href="/tags/portainer/">portainer</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/k3s/">k3s</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
